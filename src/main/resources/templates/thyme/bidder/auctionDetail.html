<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>경매 상세 페이지</title>
    <style>
        /* 스타일 생략 */
    </style>
</head>
<body>
<div th:insert="~{thyme/HeaderWithCategory}"></div>

<div class="auction-detail-container">
    <h1 th:text="${product.title}">상품 제목</h1>
    <div class="product-image">
        <!-- <img th:src="@{${product.imageUrl}}" alt="상품 이미지" /> -->
    </div>
    <div class="product-details">
        <p>설명: <span th:text="${product.description}">상품 설명</span></p>
        <p>현재 입찰가: <span id="currentPrice" th:text="${auction.highPrice}">0</span> 원</p>
        <p>남은 시간: <span th:text="${auction.period}">0</span> 일</p>
        <p>좋아요 수: <span th:text="${product.likeCount}">0</span></p>
    </div>
    <div class="bid-container">
        <button id="bidButton">입찰하기</button>
    </div>
</div>

<!-- 입찰 모달 -->
<div id="bidModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>입찰하기</h2>
        <form id="bidForm">
            <input type="number" id="bidPrice" placeholder="입찰 금액" required>
            <button type="submit">입찰</button>
        </form>
    </div>
</div>
<p>현재 로그인된 사용자: <span id="loggedUser" th:text="${loggedUser}">사용자 없음</span></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const socket = new SockJS('/ws-stomp'); // 웹소켓 연결
        const stompClient = Stomp.over(socket); // STOMP 클라이언트 생성

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/bid', function (message) {
                const newHighPrice = JSON.parse(message.body);
                console.log("New high price received: " + newHighPrice); // 로그 추가
                document.getElementById('currentPrice').innerText = newHighPrice;
            });
        });

        const modal = document.getElementById("bidModal");
        const bidButton = document.getElementById("bidButton");
        const closeButton = document.querySelector(".close");

        bidButton.addEventListener("click", function () {
            modal.style.display = "block";
        });

        closeButton.addEventListener("click", function () {
            modal.style.display = "none";
        });

        window.addEventListener("click", function (event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });

        const bidForm = document.getElementById("bidForm");
        bidForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const bidPriceString = document.getElementById("bidPrice").value;
            const bidPrice = parseInt(bidPriceString); // 문자열을 정수로 변환

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            const nickname = document.getElementById("loggedUser").innerText;

            if (productId && !isNaN(bidPrice) && nickname) {
                const payload = JSON.stringify({ price: bidPrice, productId: productId, nickname: nickname });

                // 로그 추가
                console.log("Sending bid: " + bidPrice + " for product: " + productId + " by user: " + nickname);

                fetch(`/send/bid/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload,
                    credentials: 'include'
                })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error("Failed to place bid");
                        }
                    })
                    .then(data => {
                        console.log(data);
                        window.location.href = `/auction/detail?productId=${productId}`;
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                console.error("Invalid product ID, bid price or nickname");
            }
        });
    });
</script>
</body>
</html>
