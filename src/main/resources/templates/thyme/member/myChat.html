<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MyPage</title>
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/member/editProfile.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/member/myPage.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/member/myChat.css}">
    <script>
        function formatTime(dateTimeString) {
            const dateTime = new Date(dateTimeString);
            const hours = dateTime.getHours();
            const minutes = dateTime.getMinutes().toString().padStart(2, '0');
            const period = hours >= 12 ? '오후' : '오전';
            const formattedHours = hours % 12 || 12;
            return `${period} ${formattedHours}:${minutes}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.chat-time').forEach(element => {
                const dateTimeString = element.getAttribute('data-date-time');
                element.textContent = formatTime(dateTimeString);
            });
        });
    </script>

    <style>
        .clickable {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div th:include="thyme/HeaderWithCategory"></div>

<div class="container">
    <main>
        <aside>
            <nav class="side-nav">
                <span><h3><a href="#" th:href="@{/members/my-page}">마이 페이지</a></h3></span>
                <span><a href="#" th:href="@{/members/my-page/product}">판매 내역</a></span>
                <span><a href="#" th:href="@{/members/my-page/purchase}">구매 내역</a></span>
                <span><a href="#" th:href="@{/members/my-page/auction}">경매 내역</a></span>
                <span><a href="#" th:href="@{/members/my-page/like}">좋아요한 글</a></span>
                <span><a href="#" th:href="@{/members/my-page/chat/product}">채팅 내역</a></span>
            </nav>
        </aside>
        <section class="main-section">
            <div><h2>채팅 내역</h2></div><br/>
            <div>
                <ul>
                    <li><a href="#" th:href="@{/members/my-page/chat/product}">상품</a></li><li>|</li>
                    <li><a href="#" th:href="@{/members/my-page/chat/as}">AS</a></li><li></li>
                </ul>
            </div>

            <!-- 상품 채팅 -->
            <div class="chat-history" th:if="${not #lists.isEmpty(productChatRooms)}">
                <div class="chat-item" th:each="chatRoom : ${productChatRooms}">
                    <div class="chat-image clickable">
                        <a th:href="@{/product/view(id=${chatRoom.product.id})}">
                            <img th:if="${#lists.size(chatRoom.product.productImageList) > 0}"
                                 th:src="${chatRoom.product.productImageList[0]}"
                                 alt="Profile Image">
                            <img th:if="${#lists.size(chatRoom.product.productImageList) == 0}"
                                 th:src="@{/resources/img/product_example.png}"
                                 alt="Default Image">
                        </a>
                    </div>

                    <div class="chat-info">
                        <a th:text="${chatRoom.product.title}" class="chat-title clickable"
                              th:href="@{/product/view(id=${chatRoom.product.id})}">무선 이어폰(title)</a>
                        <div class="chat-details">
                            <span th:text="${chatRoom.product.member.nickname}" class="chat-seller">OOO(판매자)</span>

                            <a th:if="${#lists.size(chatRoom.chatMessageList) > 0}"
                                  th:text="${chatRoom.chatMessageList[chatRoom.chatMessageList.size() - 1].message}"
                                  th:href="@{/chat/chatRoom/product/{productId}(productId=${chatRoom.product.id})}"
                                  class="chat-last-message clickable">마지막 채팅 메시지</a>

                            <span th:if="${#lists.size(chatRoom.chatMessageList) > 0}"
                                  th:attr="data-date-time=${chatRoom.chatMessageList[chatRoom.chatMessageList.size() - 1].createdAt}"
                                  class="chat-time">오전 hh:mm</span>

                            <span class="chat-delete">x</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- as 채팅 -->
            <div class="chat-history" th:if="${not #lists.isEmpty(asChatRooms)}">
                <div class="chat-item" th:each="chatRoom : ${asChatRooms}">
                    <div class="chat-image clickable">
                        <a th:href="@{/afterService/asInfo/{afterServiceId}(afterServiceId=${chatRoom.afterService.id})}">
                            <img th:if="${#lists.size(chatRoom.afterService.member.profile) > 0}"
                                 th:src="${chatRoom.afterService.member.profile}"
                                 alt="Profile Image">
                            <img th:if="${#lists.size(chatRoom.afterService.member.profile) == 0}"
                                 th:src="@{/resources/img/product_example.png}"
                                 alt="Default Image">
                        </a>
                    </div>


                    <div class="chat-info">
                        <div class="chat-details">
                            <span th:text="${chatRoom.afterService.member.nickname}" class="chat-seller">OOO(판매자)</span>

                            <a th:if="${#lists.size(chatRoom.chatMessageList) > 0}"
                                  th:text="${chatRoom.chatMessageList[chatRoom.chatMessageList.size() - 1].message}"
                                  th:href="@{/chat/chatRoom/afterService/{afterServiceId}(afterServiceId=${chatRoom.afterService.id})}"
                                  class="chat-last-message clickable">마지막 채팅 메시지</a>

                            <span th:if="${#lists.size(chatRoom.chatMessageList) > 0}"
                                  th:attr="data-date-time=${chatRoom.chatMessageList[chatRoom.chatMessageList.size() - 1].createdAt}"
                                  class="chat-time">오전 hh:mm</span>

                            <span class="chat-delete">x</span>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>
</div>
</body>
</html>
