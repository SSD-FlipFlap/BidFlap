<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" href="/resources/css/product/ViewProduct.css">
    <title>상품 상세 페이지</title>
    <script>
        function confirmDelete(){
            if(confirm("정말로 삭제하시겠습니까?")){
                document.getElementById('delete-form').submit()
            }
        }

        <!--판매자 :경매시작-->

        document.addEventListener("DOMContentLoaded", function() {
            // 경매 시작 관련 요소
            const startAuctionButton = document.getElementById("start-auction-button");
            const modalOverlayStartAuction = document.querySelector(".modal-overlay-start-auction");
            const closeButton = modalOverlayStartAuction.querySelector(".close-btn");
            const cancelButton = modalOverlayStartAuction.querySelector(".cancel-btn");
            const startAuctionSubmitButton = modalOverlayStartAuction.querySelector(".start-auction-submit");

            // 경매 참여 관련 요소
            const participateButton = document.querySelector(".participate-button");
            const participateModalOverlay = document.querySelector(".modal-overlay");
            const participateModalCloseButton = participateModalOverlay.querySelector(".close-btn");
            const participateConfirmButton = participateModalOverlay.querySelector(".participate-button2");
            const confirmationCheckbox = document.getElementById("confirmation-checkbox");

            // URL 경로에서 productId를 추출하는 함수
            function getProductIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id'); // URL의 쿼리 파라미터에서 'id' 값을 반환
            }

            const productId = getProductIdFromUrl();


            if (startAuctionButton) {
                startAuctionButton.addEventListener("click", function() {
                    modalOverlayStartAuction.classList.add("show");
                });

                closeButton.addEventListener("click", function() {
                    modalOverlayStartAuction.classList.remove("show");
                });

                cancelButton.addEventListener("click", function() {
                    modalOverlayStartAuction.classList.remove("show");
                });

                startAuctionSubmitButton.addEventListener("click", function() {
                    const duePeriod = document.getElementById("due-period").value;

                    if (duePeriod && productId) {
                        fetch(`/auction/start?id=${productId}&duePeriod=${duePeriod}`, {
                            method: "POST"
                        }).then(response => {
                            if (response.ok) {
                                alert("경매가 시작되었습니다!");
                                location.reload(); // 페이지를 새로고침하여 상태를 갱신합니다.
                            } else {
                                response.text().then(text => {
                                    alert("경매 시작 실패: " + text);
                                });
                            }
                        });
                    } else {
                        alert("경매 기간을 입력하세요.");
                    }
                });
            }

            // 경매 참여
            if (participateButton) {
                participateButton.addEventListener("click", function() {
                    participateModalOverlay.classList.add("show");
                });

                participateModalCloseButton.addEventListener("click", function() {
                    participateModalOverlay.classList.remove("show");
                });

                participateConfirmButton.addEventListener("click", function() {
                    if (confirmationCheckbox.checked) {
                        window.location.href = `/auction/detail?productId=${productId}`;
                    } else {
                        alert("경매 참여 조건을 확인해주세요.");
                    }
                });
            }
        });

    </script>
</head>
<body>
<div th:include="thyme/HeaderWithCategory"></div>

<div class="image-slider">
    <button class="prev-btn">＜</button>
    <div class="image-gray-box">
        <div id="productPreviewContainer">
            <!-- 각 이미지의 URL을 반복하여 화면에 출력 -->
            <div th:each="image, index : ${product.productImageList}">
                <img th:src="${image.url}" alt="Product Image" style="max-width: 191px; max-height: 191px;"
                     onclick="removePreviewImage(event, ${index.index})">
            </div>
        </div>
    </div>
    <button class="next-btn">＞</button>
</div>

<div class="line"></div>

<!-- 작성자인 경우, 아닌 경우에 따른 버튼 변경 구현 -->
<div th:if="${isAuthor}">
    <div class="purchase-unavailable">
        <div class="btn">
            <button type="button" th:text="'구매 불가능'" disabled></button>
        </div>
    </div>
    <!--경매 시작 버튼 및 모달 -->
    <div th:if="${product.likeCount >= 1}">
        <div class="start-auction-container">
            <button id="start-auction-button">경매 시작</button>
        </div>
    </div>
    <div th:if="${product.likeCount < 1}">
        <div class="auction-unavailable">
            <div class="btn">
                <button type="button" th:text="'경매 시작 불가능'" disabled></button>
            </div>
        </div>
    </div>
    <button type="button" id="like-button-author" th:text="'좋아요 ' + ${product.likeCount}"></button>
</div>


<!-- 작성자가 아닌 경우 -->
<div th:if="${!isAuthor}">
    <div class="btn" th:classappend="${product.status == 'SELLING'} ? 'purchase-unavailable' : 'purchase-available'">
        <form action="/product/purchase" method="post"> <!-- GET 방식에서 POST 방식으로 변경 -->
            <input type="hidden" name="id" th:value="${product.id}" /> <!-- 상품 id를 hidden 필드로 전송 -->
            <button type="submit" th:text="${product.status == 'AUCTION' ? '구매 불가능' : '구매하기'}" th:disabled="${product.status == 'AUCTION'}"></button>
        </form>
    </div>

    <div th:if="${product.status == 'AUCTION'}" class="bid-available">
        <div class="btn">
            <button class="participate-button" type="button" th:text="'경매 참여하기'"></button>
        </div>
    </div>
    <div th:if="${product.status != 'AUCTION'}" class="bid-unavailable">
        <!--        <div class="btn">-->
        <!--            <button type="button" th:text="'경매 참여 불가능'"></button>-->
        <!--        </div>-->
        <div class="btn">
            <button class="participate-button" type="button" th:text="'경매 참여하기'"></button>
        </div>
    </div>

    <form id="like-form" action="/product/like" method="post">
        <input type="hidden" name="productId" th:value="${product.id}"/>
        <button type="submit" id="like-button-non-author" th:text="'좋아요 ' + ${product.likeCount}"></button>
    </form>
</div>
<!-- 작성자인 경우에만 수정 및 삭제 버튼 표시 -->
<div th:if="${isAuthor}">
    <form id="delete-form" th:action="@{/product/delete/{id}(id=${product.id})}" method="post">
        <input type="hidden" name="_method" value="DELETE"/>
        <button type="button" id="delete-button" onclick="confirmDelete()">글 삭제</button>
    </form>

    <a th:href="@{/product/modify/{id}(id=${product.id})}">
        <button id="modify-button" type="button">글 수정</button>
    </a>
</div>

<div class="auction-notice">경매 시작 가능 | 10명 이상 좋아요</div>

<div class="writer-profile">
    <span th:text="${product.member.nickname} + '님'"></span>
    <span th:text="${#temporals.format(product.createdAt, 'yyyy년 MM월 dd일 HH시 mm분') + '에 작성하셨습니다.'}"></span>
</div>

<div class="profile-picture"></div>
<div class="price" th:text="${product.price != null ? product.price + '원' : ''}"></div>
<div class="product-title" th:text="${product.title}"></div>
<div class="product-description" th:text="${product.description}"></div>
<div class="product-category" th:text="${product.category != null ? '#' + product.category : ''}"></div>
<div class="writer-price">판매자 제시가</div>
<!--상품 상태 확인용 디버그 코드-->
<div th:text="'Product Status: ' + ${product.status}"></div>
<!--경매 참여 모달 -->
<div class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>경매 참여자에게 알립니다.</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p>경매 참여시 안전 거래를 위해 판매가 일정 금액 이상일 경우 가격의 5%,<br/> 미만일 경우 기본 금액의 보증금을 납부해야합니다. <br/><br/>
                낙찰 시 경매품에 대한 수락 혹은 거부의사를 3일 안에 전달해야합니다.<br/><br/> 낙찰 수락 시 ,결제가 가능하며 이후 보증금이 반환됩니다.  <br/>
                낙찰 수락 후 결제를 취소하는 경우, 보증금은 돌려받을 수 없습니다.  <br/>
                낙찰 거부시, 다음 순위의 참여자에게 기회가 넘어갑니다. </p>
            <label for="confirmation-checkbox">
                <input type="checkbox" id="confirmation-checkbox"> 위 사항을 확인했습니다.
            </label>
            <br/><br/>
            <button class="participate-button2">경매참여</button>
        </div>
    </div>
</div>
<!-- 경매 시작 모달 -->
<div class="modal-overlay modal-overlay-start-auction">
    <div class="modal">
        <div class="modal-header">
            <h2>경매 시작하기</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p>경매 기간을 설정하세요 (일 단위):</p>
            <input type="number" id="due-period" min="1" required>
            <br/><br/>
            <button class="start-auction-submit">경매 시작</button>
            <button class="cancel-btn">취소</button>
        </div>
    </div>
</div>

</body>

</html>
